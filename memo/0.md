# ObservedProperties

　値を代入したら任意の処理を実行するオブジェクトを生成する。デザインパターンの一つObserverを利用している。モデル駆動とも言う。

* Type		型判定
* Valid		値の妥当性確認（Range,Options）
* Assign	値が代入された時（型や妥当性は不問）
* Change	値が変更された時（型が正しく、値が妥当である。Updateする直前）
* setup		値を一括設定しつつUpdateは一度だけ行う（複数の値を個別に設定するとその数だけUpdateが実行されてしまい負荷が高いから一度だけ行う）
* update	関連する値やHTML要素などを再計算する

```javascript
const o = new Obs({
  name:{type:String, value:'v', valid:/[a-z_][0-9a-z_]/i}, 
  age:{type:Number, value:12, valid:Obs.Valid.Range(0, 100)},
  male:{type:Boolean, value:false},
  _:{
    message:{type:String, value:''},
  }},
  (o)=>{
    o._.message = `私の名前は ${o.name}、${o.age} 歳、${o.male ? '男' : '女'}です。`;
  }
);
o.name = 'X';
o.age = 34;
o.male = true;
o.notHas // TypeError: 存在しないプロパティ名です
o.name = 12; // TypeError: 型が違います。
o.setup({name:'Y', age:56}); // 複数のプロパティを好きな分だけ好きなように変更する。更新処理は一度だけ実行される。
```
```javascript
const o = new Obs({...;
class C {}
defineDescriptor(ins, o);
const c = new C();
c.name = 'X';
o.notHas // TypeError: 存在しないプロパティ名です
```
```javascript
const o = new Obs({
  name:{type:String, value:'v', valid:/[a-z_][0-9a-z_]/i}, 
  age:{type:Number, value:12, valid:Obs.Valid.Range(0, 100)},
  male:{type:Boolean, value:false},
  name:{type:String, value:'v', valid:Obs.Valid.Option('山田', '鈴木', '田中')}, 
  name:{type:String, value:'v', valid:Obs.Valid.Unique('山田', '鈴木', '田中')}, 
  name:{type:Uint8Array, args:[128]}, 
  name:{value:new Uint8Array(128)}, 
  name: new Uint8Array(128), 
  name: new Obs({
    name:{type:String, value:'v', valid:/[a-z_][0-9a-z_]/i}, 
  }),
```
変数と定数では別のコンストラクタを用意したほうがいいかもしれない。`mutable:true`を全プロパティにセットするの面倒すぎる。
```javascript
const o = new Obs({
  name:{
      type:String, 
      value:'v', 
      nullable:false, undefinedable:false, nanable:false, infinitable:false, mutable:false,
      valid:/[a-z_][0-9a-z_]/i,
  }, 
```
```javascript
const o = new Obs({
  name: '山田',
  age: 12,
  male: false,
  // オブジェクト型はすべて参照に対してのみSetterで型チェック等を行う。オブジェクトが持つ子要素に対しては対象外
  url: new URL('https://www.google.co.jp/'),
  pattern: new RegExp('\n{2,}', 'g'),
  ary: [],
  obj: {}, // 
  sub: new Obs({...}),
});
```

　型は初期値によって推測可能なはず。但し`12`はNumber型であり整数も少数も無限数も非安全な2^53-1より大きい整数も取れてしまう。困る。

　クラス定義でもGetter/Setterに対して同じことをしたい。

```javascript
class MyObsProp extends Obs {
    constructor() {
        super({
            name:{type:String, value:'v', valid:/[a-z_][0-9a-z_]/i}, 
        });
    }
}
```

　でもそれだけじゃ思い通りに制御できない。値の参照・代入・型妥当性チェックを自在に呼び出したい。

```javascript
class MyObsProp extends Obs {
    constructor() {
        super({
            name:{type:String, value:'v', valid:/[a-z_][0-9a-z_]/i, setter:(v)=>{/*this.name に値を代入した直後に実行される処理をここで埋め込み可能*/}}, 
        }, (o)=>{
            // いずれかのプロパティに値が代入されたら必ず実行する処理をここで実装する
            // o.name などで参照・代入できる
        });
    }
}
```
```javascript
const 変数 = Obs.var({...}); // mutable:true がデフォルト
const 定数 = Obs.fix({...}); // mutable:false がデフォルト
const props = new Obs.Cls({}, {...}, (o, c)=>{}) // 第一引数に任意オブジェクトを渡すと、そのオブジェクトに対してgetter/setterを作る
class MyObsProp extends Obs.Cls { // 第一引数にインスタンス変数thisを渡すと、自動的にgetter/setterを作ってくれる
    constructor() {
        super(this, {
            name:{type:String, value:'v', valid:/[a-z_][0-9a-z_]/i, setter:(v)=>{/*this.name に値を代入した直後に実行される処理をここで埋め込み可能*/}}, 
        }, (o)=>{
            // いずれかのプロパティに値が代入されたら必ず実行する処理をここで実装する
            // o.name などで参照・代入できる
        });
    }
    
}
```
```javascript
window.oo = ObservedObject;
window.ooo = ObservedObjectOwner;
```
```javascript
const 変数 = oo.var({...}); // mutable:true がデフォルト
const 定数 = oo.fix({...}); // mutable:false がデフォルト
const props = new oo.Cls({}, {...}, (o, c)=>{}) // 第一引数に任意オブジェクトを渡すと、そのオブジェクトに対してgetter/setterを作る
class MyObsProp extends oo.Cls { // 第一引数にインスタンス変数thisを渡すと、自動的にgetter/setterを作ってくれる
    constructor() {
        super(this, {
            name:{type:String, value:'v', valid:/[a-z_][0-9a-z_]/i, setter:(v)=>{/*this.name に値を代入した直後に実行される処理をここで埋め込み可能*/}}, 
        }, (o)=>{
            // いずれかのプロパティに値が代入されたら必ず実行する処理をここで実装する
            // o.name などで参照・代入できる
        });
    }
    
}
```

* 除外
	* Symbol
	* undefined
* 条件付き許容
	* null
* Boolean
* Number(NaN,±Infinityも含む)
	* Finite
		* Integer(SafeInteger(-2^53-1〜+2^53-1))
		* Float
* BigInt
* Function（AsyncFunction/GeneratorFunction/AysncGeneratorFunction/アロー関数/Asyncアロー関数）
* String
* 欲しいけど無い
	* ID（UUIDv4,v7/ULID）
	* DateTime
		* Date
		* Time
		* TimeSpan
		* DateSpan
		* DateTimeSpan
	* Color（CSS(red, #fff, #ffffff, #ffffffff)）
	* URL
const obs = ObservedValues({
  name: {nullable:false, undefinedable:false, nanable:false, inifitable:false, mutable:false, observable},
});
